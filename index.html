<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>SBrickPy - Learning</title>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
    <style>a img,a img:hover{border-color:#d85d5d}#sidebar h1,a{color:#d85d5d}#menu a,#sidebar{background:url(sidebarbg.gif) top right repeat-y #e0e0e0}#menu a,a{text-decoration:none}#content h1,#content h2{margin:0;text-align:center}#sidebar,#sidebar h1,#xform{text-align:right}body{margin:0;padding:0;color:#303030;background:url(bodybg.gif) top left repeat-y #fafafa;font:76% Verdana,Tahoma,sans-serif}ul{list-style:circle;margin:15px 0 20px;font-size:.9em}li{margin:0 0 8px 25px}a{font-weight:700}a:hover{color:#505050;text-decoration:underline}img{float:left;margin:0 15px 15px 0;padding:1px;background:#fff;border:1px solid #d0d0d0}#menu a,#menu a.active{padding:5px 18px 5px 0}a img:hover{background:#d85d5d}#sidebar{position:absolute;top:0;left:0;width:220px;height:100%;overflow:auto}body>#sidebar{position:fixed}#sidebar h1{margin:20px 18px 0 5px;font-size:1.6em;letter-spacing:-2px}#sidebar h2,#sidebar h3{margin:0 20px 18px 5px;color:grey;font-size:1.1em;font-weight:700;letter-spacing:-1px;text-align:right}#content h2,#content h3,#menu a{font-weight:400;letter-spacing:-2px}#sidebar h3{margin:20px 18px 4px 5px;color:#606060}#sidebar p{margin:0 20px 18px 5px;color:#606060;font-size:.8em}#sidebar a{color:grey}#menu a{display:block;width:202px;color:#606060;font-size:1.8em}#menu a:hover{color:#303030;background:url(sidebarbg.gif) top right repeat-y #f0f0f0}#menu a.active{background:#fafafa;border-top:2px solid silver;border-bottom:2px solid silver}#menu a.active:hover{color:#505050;background:#fafafa}#content{width:520px;margin:0 0 0 240px;padding:20px 0;background:#fafafa}#content p{margin:0 0 20px;line-height:1.5em}#content h1{color:#d85d5d;font-size:4em;letter-spacing:-5px}#content h2{color:grey;font-size:2.5em}#content h3{clear:both;margin:30px 0 10px;color:#d85d5d;font-size:2em}#streamimage{width:520px;height:390px}#xform{margin:0!important}#streamwrap{height:350px}#streamwrap.rotated{height:450px}p.xform-p{height:5px;margin-bottom:0!important}p.xform-p.rotated{height:50px;margin-bottom:20px!important}img.x-rotated-90{-moz-transform:rotate(90deg);-webkit-transform:rotate(90deg)}img.x-rotated-180{-moz-transform:rotate(180deg);-webkit-transform:rotate(180deg)}img.x-rotated-270{-moz-transform:rotate(270deg);-webkit-transform:rotate(270deg)}img.x-mirrored-rotated-0{-moz-transform:scaleX(-1);-webkit-transform:scaleX(-1)}img.x-mirrored-rotated-90{-moz-transform:rotate(90deg) scaleX(-1);-webkit-transform:rotate(90deg) scaleX(-1)}img.x-mirrored-rotated-180{-moz-transform:rotate(180deg) scaleX(-1);-webkit-transform:rotate(180deg) scaleX(-1)}img.x-mirrored-rotated-270{-moz-transform:rotate(270deg) scaleX(-1);-webkit-transform:rotate(270deg) scaleX(-1)}img.x-flipped-rotated-0{-moz-transform:scaleY(-1);-webkit-transform:scaleY(-1)}img.x-flipped-rotated-90{-moz-transform:rotate(90deg) scaleY(-1);-webkit-transform:rotate(90deg) scaleY(-1)}img.x-flipped-rotated-180{-moz-transform:rotate(180deg) scaleY(-1);-webkit-transform:rotate(180deg) scaleY(-1)}img.x-flipped-rotated-270{-moz-transform:rotate(270deg) scaleY(-1);-webkit-transform:rotate(270deg) scaleY(-1)}img.x-flipped-mirrored-rotated-0{-moz-transform:scale(-1,-1);-webkit-transform:scale(-1,-1)}img.x-flipped-mirrored-rotated-90{-moz-transform:rotate(90deg) scale(-1,-1);-webkit-transform:rotate(90deg) scale(-1,-1)}img.x-flipped-mirrored-rotated-180{-moz-transform:rotate(180deg) scale(-1,-1);-webkit-transform:rotate(180deg) scale(-1,-1)}img.x-flipped-mirrored-rotated-270{-moz-transform:rotate(270deg) scale(-1,-1);-webkit-transform:rotate(270deg) scale(-1,-1)}.btnface{height:30px;width:30px}#rotate .btnface{background:url(rotateicons.png) 7px 50% no-repeat}#flip .btnface{background:url(rotateicons.png) -65px 50% no-repeat}#mirror .btnface{background:url(rotateicons.png) -30px 50% no-repeat}#fN{position:relative;top:5px}</style>
    <!--[if IE 6]>
      <style>html{overflow:hidden;}body{height:100%; width:100%; overflow:auto;}</style>
    <![endif]-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script type="text/javascript">

        var keys = {};

        window.addEventListener("keydown", function(e) {
            // space and arrow keys
            if([37,38,39,40, 87, 65, 83, 68].indexOf(e.keyCode) > -1) {
                e.preventDefault();
            }
        }, false);

        $(document).keydown(function (e) {
            keys[e.which] = true;
            
            var json_upload = JSON.stringify({command:keys});
            $.post('/post', json_upload, function(res){
              val = JSON.parse(res);
              $('#temperature').html(val.temperature); 
              $('#voltage').html(val.voltage);
              printKeys();
            });

        });

        $(document).keyup(function (e) {
            delete keys[e.which];
            
            var json_upload = JSON.stringify({command:keys});
            $.post('/post', json_upload, function(res){
              val = JSON.parse(res);
              $('#temperature').html(val.temperature); 
              $('#voltage').html(val.voltage);
              printKeys();
            });
        });

        function printKeys() {
            var html = '';
            for (var i in keys) {
                if (!keys.hasOwnProperty(i)) continue;
                html += '<p>Key: ' + i + '</p>';
            }
            $('#out').html(html);
        }

      /* Copyright (C) 2007 Richard Atterer, richardÂ©atterer.net
       * This program is free software; you can redistribute it and/or modify it
       * under the terms of the GNU General Public License, version 2. See the file
       * COPYING for details.
       */

      var imageNr = 0; // Serial number of current image
      var finished = new Array(); // References to img objects which have finished downloading
      var paused = false;
      var previous_time = new Date();
      var fNi = 0, msAvg = 0, fpsAvg = 0, fcnt = 0, fN = 80, msa = [], wsize = 4;

      function createImageLayer() {
        var img = new Image();
        img.style.position = "absolute";
        img.style.zIndex = -1;
        img.onload = imageOnload;
        img.onclick = imageOnclick;
        img.width = 512;
        img.height = 384;
        img.src = "http://raspberrypi.local:8080/?action=snapshot&n=" + (++imageNr);
        var webcam = document.getElementById("webcam");
        window.info = document.getElementById('info').firstChild;
        window.ravgFps = document.getElementById('ravgfps').firstChild;
        window.ravgMs = document.getElementById('ravgms').firstChild;
        webcam.insertBefore(img, webcam.firstChild);
        document.getElementById('fN').firstChild.nodeValue = fN;
      }
	

	function runningAvgs (delta) {
		// delta is the measured frame period
		var len;
		if (fcnt < fN) {

			fcnt++;
			// we need to populate the sample array
			msa.push(delta);
			// calculate average period so far
			msAvg += (delta - msAvg) / fcnt;
			
		} else {
			/*
				running average (fN samples) according to the formula:
				rAvg = rAvg - value_fN_samples_back / fN + newest_value / fN
			*/
			msAvg += (delta - msa[0])/fN;
			// drop oldest ms value, msa[0]
			msa = msa.slice(1);
			// append newest value, delta
			msa.push(delta);
		}
		// calculate average fps
		fpsAvg = 1000 / msAvg;
		/*
			once every fN frames, check if we need to adjust the averaging window
			since faster rates seem to need more samples to reach a stable(er) readout
		*/
		if (++fNi == fN) {

			fNi = 0;
			// new window size
			fN = parseInt(fpsAvg * wsize);
			len = fcnt - fN;
			// if our sample array, msa, has extra samples, then trim it to the new size
			if (len > 0) {

				// adjust averaging window (nr of samples)
				msa = msa.splice(len);
				// avoid populating the sample array again
				fcnt = fN;
			}
		}
	}

      // Two layers are always present (except at the very beginning), to avoid flicker
      function imageOnload() {
        this.style.zIndex = imageNr; // Image finished, bring to front!
        while (1 < finished.length) {
          var del = finished.shift(); // Delete old image(s) from document
          del.parentNode.removeChild(del);
        }
        finished.push(this);
        current_time = new Date();
        delta = current_time.getTime() - previous_time.getTime();
        fps   = (1000.0 / delta).toFixed(1);
		runningAvgs(delta);
        info.nodeValue = delta + " ms (" + fps + " fps)";
		ravgFps.nodeValue = fpsAvg.toFixed(1);
		ravgMs.nodeValue = msAvg.toFixed(0);
		previous_time = current_time;
        if (!paused) createImageLayer();
      }

      function imageOnclick() { // Clicking on the image will pause the stream
        paused = !paused;
        if (!paused) createImageLayer();
      }

    </script>
  </head>

  <body onload="createImageLayer();">
    <div id="sidebar">
      <h1>SBrickPy</h1>
      <h2>Autonomous Lego vehicle with a ANN (Tensorflow), Raspberry Pi and SBrick</h2>

      <div id="menu">
        <a href="index.html">Learning</a>
        <a href="index.html">Setup</a>
        <a href="training.html">Training</a>
        <a href="ai_drive.html">AI Drive</a>

    </div>

      <h3>Version info:</h3>
      <p>v0.1 (May 21, 2018)</p>

      <h3>Runtime info:</h3>
      <p><span id="info">-</span><br/>
      Avg<sub id="fN">-</sub> : <span  id="ravgms">-</span> ms (<span  id="ravgfps">-</span> fps)
      </p>
      </div>

    <div id="content">
      <h1>Learning</h1>
      <h2>Use keyboard arrows to go forward, left forward, right forward or backward. Use WASD for actuator</h2>

      <h3>Hints</h3>
    <p> Drive as if your only source of information is the camera - No eye or hand of god</p>

        <div id="webcam" style="width:512px;height:394px"><noscript><img src="./?action=snapshot" width="512px" height="384px" /></noscript></div>
        <div>Voltage: <span id="voltage"></span>| Temperature: <span id="temperature"></span></div>
        <div id="out"></div>

      <p>&copy; Work by <a href="http://studiozenkai.com">Heri</a></p>
    </div>
  </body>
</html>

